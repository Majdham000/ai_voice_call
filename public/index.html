<!DOCTYPE html>
<html>
<head>
  <title>GPT-4o Voice Talk</title>
</head>
<body>
  <h1>GPT-4o Voice Talk</h1>
  <script>
  async function init() {
    const tokenResponse = await fetch("/session");
    const data = await tokenResponse.json();
    const EPHEMERAL_KEY = data.client_secret.value;

    const pc = new RTCPeerConnection();
    const audioEl = document.createElement("audio");
    audioEl.autoplay = true;
    document.body.appendChild(audioEl);

    pc.ontrack = e => audioEl.srcObject = e.streams[0];

    const ms = await navigator.mediaDevices.getUserMedia({ audio: true });
    pc.addTrack(ms.getTracks()[0]);

    const dc = pc.createDataChannel("oai-events");
    dc.addEventListener("message", (e) => {
      console.log("Event:", e.data);
    });

    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);

    console.log("Using EPHEMERAL_KEY:", EPHEMERAL_KEY);

    const baseUrl = "https://api.openai.com/v1/realtime";
    const model = "gpt-4o-realtime-preview-2024-12-17";
    const sdpResponse = await fetch(`${baseUrl}?model=${model}`, {
      method: "POST",
      body: offer.sdp,
      headers: {
        Authorization: `Bearer ${EPHEMERAL_KEY}`,
        "Content-Type": "application/sdp"
      },
    });

    if (!sdpResponse.ok) {
      console.error("Error fetching SDP:", sdpResponse.statusText);
      return;
    }

    const sdpText = await sdpResponse.text();
    console.log("Received SDP:", sdpText);

    try {
      const answer = {
        type: "answer",
        sdp: sdpText,
      };
      await pc.setRemoteDescription(answer);
    } catch (err) {
      console.error("Error setting remote description:", err);
    }
  }

  init();

  </script>
</body>
</html>


